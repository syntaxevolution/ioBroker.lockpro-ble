{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from \"@iobroker/adapter-core\";\r\nimport Switchbot = require(\"node-switchbot\");\r\n\r\n/**\r\n * ioBroker adapter class for SwitchBot\u00A0Lock\u00A0Pro over BLE (no cloud).\r\n * `node-switchbot` exports a factory *function* (not a class), so we call it\r\n * directly and keep the typings loose (`any`).\r\n */\r\nclass LockProBle extends utils.Adapter {\r\n    private sb: any;          // SwitchBot BLE transport\r\n    private lock?: any;       // WoSmartLock instance\r\n    private pollTimer?: NodeJS.Timeout;\r\n\r\n    constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n        super({ ...options, name: \"lockpro-ble\" });\r\n\r\n        // ioBroker typings miss the generic EventEmitter overloads \u2192 cast to any\r\n        (this as any).on(\"ready\", this.onReady.bind(this));\r\n        (this as any).on(\"stateChange\", this.onStateChange.bind(this));\r\n        this.on(\"unload\", this.onUnload.bind(this));\r\n\r\n        // create BLE stack \u2013 respect HCI selection from config\r\n        this.sb = Switchbot((this.config as any).bleHci || undefined);\r\n    }\r\n\r\n    /** Called once all adapter settings are present. */\r\n    private async onReady(): Promise<void> {\r\n        const cfg = this.config as any;\r\n        if (!cfg.lockMac) {\r\n            this.log.error(\"No MAC address configured \u2013 aborting.\");\r\n            return;\r\n        }\r\n\r\n        this.log.info(`Scanning for Lock\u00A0Pro (${cfg.lockMac}) \u2026`);\r\n        await this.sb.startScan();\r\n        try {\r\n            this.lock = await this.sb.waitFirst(\r\n                (d: any) => d.model === \"p\" && d.address.toLowerCase() === cfg.lockMac.toLowerCase(),\r\n                30_000,\r\n            );\r\n        } finally {\r\n            await this.sb.stopScan();\r\n        }\r\n\r\n        if (!this.lock) throw new Error(\"Lock\u00A0Pro not found \u2013 check MAC / distance / power\");\r\n        if (this.lock?.rssi !== undefined) this.log.info(`Found Lock\u00A0Pro via BLE at RSSI ${this.lock.rssi}`);\r\n\r\n        // enable encryption if keys provided\r\n        if (cfg.keyId && cfg.encKey) this.lock.setKey(cfg.keyId, cfg.encKey);\r\n\r\n        await this.defineObjects();\r\n        await this.updateStatus();\r\n\r\n        const poll = Number(cfg.poll) || 15;\r\n        this.pollTimer = setInterval(() => this.updateStatus(), poll * 1000);\r\n    }\r\n\r\n    /** Declare the ioBroker object tree. */\r\n    private async defineObjects(): Promise<void> {\r\n        await this.extendObjectAsync(\"state\", { type: \"channel\" });\r\n\r\n        await this.extendObjectAsync(\"state.locked\", {\r\n            type: \"state\",\r\n            common: { name: \"locked\", type: \"boolean\", role: \"lock\", read: true, write: false },\r\n            native: {},\r\n        });\r\n\r\n        await this.extendObjectAsync(\"state.battery\", {\r\n            type: \"state\",\r\n            common: { name: \"battery\", type: \"number\", role: \"value.battery\", unit: \"%\", read: true, write: false },\r\n            native: {},\r\n        });\r\n\r\n        await this.extendObjectAsync(\"state.door\", {\r\n            type: \"state\",\r\n            common: { name: \"doorState\", type: \"string\", role: \"sensor.door\", read: true, write: false },\r\n            native: {},\r\n        });\r\n\r\n        // command buttons -----------------------------------------------------\r\n        const button: any = { type: \"state\", common: { role: \"button\", type: \"boolean\", read: false, write: true }, native: {} };\r\n        await this.extendObjectAsync(\"cmd.lock\", button);\r\n        await this.extendObjectAsync(\"cmd.unlock\", button);\r\n        await this.extendObjectAsync(\"cmd.unlockNoUnlatch\", button);\r\n    }\r\n\r\n    /** Poll lock / battery / door status. */\r\n    private async updateStatus(): Promise<void> {\r\n        if (!this.lock) return;\r\n        try {\r\n            const s = await this.lock.getLockState();\r\n            await this.setStateChangedAsync(\"state.locked\", !!s.lockState, true);\r\n            if (typeof s.battery === \"number\") await this.setStateChangedAsync(\"state.battery\", s.battery, true);\r\n            if (s.doorState !== undefined) await this.setStateChangedAsync(\"state.door\", s.doorState, true);\r\n        } catch (e) {\r\n            this.log.error(`Status update failed: ${e}`);\r\n        }\r\n    }\r\n\r\n    /** Handle button presses. */\r\n    private async onStateChange(id: string, state: ioBroker.State | null): Promise<void> {\r\n        if (!state || state.ack) return;\r\n        if (!this.lock) return;\r\n        try {\r\n            if (id.endsWith(\"cmd.lock\")) await this.lock.lock();\r\n            else if (id.endsWith(\"cmd.unlockNoUnlatch\")) await this.lock.unlockNoUnlatch();\r\n            else if (id.endsWith(\"cmd.unlock\")) await this.lock.unlock();\r\n        } catch (e) {\r\n            this.log.warn(String(e));\r\n        } finally {\r\n            await this.setStateAsync(id, false, true); // reset push\u2011button\r\n        }\r\n    }\r\n\r\n    /** Adapter unload. */\r\n    private async onUnload(callback: () => void): Promise<void> {\r\n        if (this.pollTimer) clearInterval(this.pollTimer);\r\n        try {\r\n            await this.sb.stopScan();\r\n        } catch {\r\n            /* ignore */\r\n        }\r\n        callback();\r\n    }\r\n}\r\n\r\n// Factory export & standalone execution\r\nexport = (o?: Partial<utils.AdapterOptions>) => new LockProBle(o);\r\nif (require.main === module) new LockProBle();"],
  "mappings": "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",
  "names": []
}
